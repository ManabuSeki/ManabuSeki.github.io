<!doctype html> 
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="hPEM88DJIkoFEORP5k4twCs5-g0h9euejtqoCUBExXk" name="google-site-verification" />
    <title>GakuBlog | CentOS7でLDAP</title>
    <meta content="centosにOpenLDAPを導入する

LDAPとは

ネットワーク機器やユーザーなどの情報を管理するディレクトリサービスへ接続するためのプロトコル。

今回構築する目的は自宅サーバー群のID..." name="description" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><!--[if lt IE 9]><script src="../../../../js/ie8.js" type="text/javascript"></script><![endif]--><link href="../../../../css/all.css" media="screen" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">GakuBlog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav"></ul>
          <ul class="list-unstyled list-inline nav navbar-nav navbar-right">
            <li>
              <a href="https://twitter.com/Gaku07jp"><i class="fa fa-twitter-square fa-lg fa-inverse"></i></a>
            </li>
            <li>
              <a href="/feed.xml"><i class="fa fa-rss-square fa-lg fa-inverse"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-9">
          <h1>
            CentOS7でLDAP
          </h1>
          <small class="label label-default">ldap</small>
          <small class="label label-default">centos</small>
          <hr />
          <p>
            <span class="glyphicon glyphicon-time"></span> 投稿日 2017年08月01日
          </p>
          <hr /><p>centosにOpenLDAPを導入する</p>

<h3>LDAPとは</h3>

<p>ネットワーク機器やユーザーなどの情報を管理するディレクトリサービスへ接続するためのプロトコル。</p>

<p>今回構築する目的は自宅サーバー群のID・パスワードの管理を容易に行えるようにするため</p>

<p>OpenLDAPを導入する前にOpenLDAPが利用するプロトコルへの接続を許可する</p>

<h3>firewallの設定</h3>

<h4>ldap(389) ldaps(686)のアクセスを許可する</h4>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> firewall-cmd <span class="nt">--add-service</span><span class="o">=</span>ldap <span class="nt">--zone</span><span class="o">=</span>public <span class="nt">--permanent</span>
<span class="go">success
</span><span class="gp">#</span> firewall-cmd <span class="nt">--add-service</span><span class="o">=</span>ldaps <span class="nt">--zone</span><span class="o">=</span>public <span class="nt">--permanent</span>
<span class="go">success
</span><span class="gp">#</span> firewall-cmd <span class="nt">--reload</span>
<span class="go">success

</span><span class="gp">#</span> firewall-cmd <span class="nt">--list-all</span>
<span class="go">public (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens160
  sources:
  services: dhcpv6-client ldap ldaps ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  sourceports:
  icmp-blocks:
  rich rules:
</span></code></pre></div>
<h3>OpenLDAPのインストール</h3>

<h4>OpenLDAPのインストールをする</h4>

<p>(横に長いので一部編集)</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> yum <span class="nt">-y</span> install openldap openldap-clients openldap-servers
<span class="go">
読み込んだプラグイン:fastestmirror
Loading mirror speeds from cached hostfile
 * base: ftp.iij.ad.jp
 * extras: ftp.iij.ad.jp
 * updates: ftp.iij.ad.jp
パッケージ openldap-2.4.40-13.el7.x86_64 はインストール済みか最新バージョンです
依存性の解決をしています
</span><span class="gp">--&gt;</span> トランザクションの確認を実行しています。
<span class="gp">---&gt;</span> パッケージ openldap-clients.x86_64 0:2.4.40-13.el7 を インストール
<span class="gp">---&gt;</span> パッケージ openldap-servers.x86_64 0:2.4.40-13.el7 を インストール
<span class="gp">--&gt;</span> 依存性の処理をしています: libltdl.so.7<span class="o">()(</span>64bit<span class="o">)</span> のパッケージ: openldap-servers-2.4.40-13.el7.x86_64
<span class="gp">--&gt;</span> トランザクションの確認を実行しています。
<span class="gp">---&gt;</span> パッケージ libtool-ltdl.x86_64 0:2.4.2-22.el7_3 を インストール
<span class="gp">--&gt;</span> 依存性解決を終了しました。
<span class="go">
依存性を解決しました

============================================================================================
 Package                                アーキテクチャー  バージョン     リポジトリー  容量
============================================================================================
インストール中:
 openldap-clients                       x86_64            2.4.40-13.el7  base         188 k
 openldap-servers                       x86_64            2.4.40-13.el7  base         2.1 M
依存性関連でのインストールをします:
 libtool-ltdl                           x86_64            2.4.2-22.el7_3 updates       49 k

トランザクションの要約
============================================================================================
インストール  2 パッケージ (+1 個の依存関係のパッケージ)

総ダウンロード容量: 2.4 M
インストール容量: 5.3 M
Downloading packages:
(1/3): libtool-ltdl-2.4.2-22.el7_3.x86_64.rpm                           |  49 kB  00:00:00
(2/3): openldap-clients-2.4.40-13.el7.x86_64.rpm                        | 188 kB  00:00:00
(3/3): openldap-servers-2.4.40-13.el7.x86_64.rpm                        | 2.1 MB  00:00:00
---------------------------------------------------------------------------------------------
合計                                                                     8.1 MB/s | 2.4 MB  00:00:00
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  インストール中          : libtool-ltdl-2.4.2-22.el7_3.x86_64                  1/3
  インストール中          : openldap-servers-2.4.40-13.el7.x86_64               2/3
  インストール中          : openldap-clients-2.4.40-13.el7.x86_64               3/3
  検証中                  : libtool-ltdl-2.4.2-22.el7_3.x86_64                  1/3
  検証中                  : openldap-clients-2.4.40-13.el7.x86_64               2/3
  検証中                  : openldap-servers-2.4.40-13.el7.x86_64               3/3

インストール:
  openldap-clients.x86_64 0:2.4.40-13.el7                 openldap-servers.x86_64 0:2.4.40-13.el7

依存性関連をインストールしました:
  libtool-ltdl.x86_64 0:2.4.2-22.el7_3

完了しました!
</span></code></pre></div>
<h4>DB設定をサンプルからコピーする</h4>
<div class="highlight"><pre class="highlight plaintext"><code># cp -p /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
</code></pre></div>
<h4>システム起動時に自動的に起動するようにする</h4>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> systemctl <span class="nb">enable </span>slapd
<span class="go">Created symlink from /etc/systemd/system/multi-user.target.wants/slapd.service to /usr/lib/systemd/system/slapd.service.
</span></code></pre></div>
<h4>サービス起動</h4>
<div class="highlight"><pre class="highlight plaintext"><code>systemctl start  slapd
</code></pre></div>
<h4>起動確認</h4>
<div class="highlight"><pre class="highlight plaintext"><code># systemctl status slapd
● slapd.service - OpenLDAP Server Daemon
   Loaded: loaded (/usr/lib/systemd/system/slapd.service; enabled; vendor preset: disabled)
   Active: active (running) since 火 2017-08-01 11:30:38 JST; 32s ago
     Docs: man:slapd
           man:slapd-config
           man:slapd-hdb
           man:slapd-mdb
           file:///usr/share/doc/openldap-servers/guide.html
  Process: 11697 ExecStart=/usr/sbin/slapd -u ldap -h ${SLAPD_URLS} $SLAPD_OPTIONS (code=exited, status=0/SUCCESS)
  Process: 11682 ExecStartPre=/usr/libexec/openldap/check-config.sh (code=exited, status=0/SUCCESS)
 Main PID: 11699 (slapd)
   CGroup: /system.slice/slapd.service
           └─11699 /usr/sbin/slapd -u ldap -h ldapi:/// ldap:///
</code></pre></div>
<h2>slapd.dデータの編集</h2>

<h4>作業用ディレクトリ作成</h4>
<div class="highlight"><pre class="highlight plaintext"><code># cd ~
# mkdir ~/ldap_work
</code></pre></div>
<h4>パスワードを生成する</h4>

<p>ソルト付きSSHAな為生成ごとに異なる</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> slappasswd
<span class="go">New password:
Re-enter new password:
{SSHA}sWdvM8tQw3JomdNrpQSM3IEYUn6pDBis
</span></code></pre></div>
<h4>configデータベースのRootユーザのパスワードを変更する</h4>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> vi ~/ldap_work/add_rootPw.ldif
<span class="go">dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: {SSHA}sWdvM8tQw3JomdNrpQSM3IEYUn6pDBis
</span></code></pre></div>
<h4>ldapaddコマンドで、add_rootPw.ldifの内容と登録する</h4>

<p>-Y EXTERNALとをつけることでローカル環境からパスワード無しでコマンドを実行できる</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> ldapadd <span class="nt">-Y</span> EXTERNAL <span class="nt">-H</span> ldapi:// <span class="nt">-f</span> ~/ldap_work/add_rootPw.ldif
<span class="go">SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "olcDatabase={0}config,cn=config"
</span></code></pre></div>
<h3>LDAPベースエントリの変更</h3>

<h4>インストール直後のベースDNはmy-domain,dc=comとなっている為変更する</h4>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> vi ~/ldap_work/change-domain.ldif
<span class="go">dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth"
  read by dn.base="cn=Manager,dc=example,dc=com" read by * none

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=example,dc=com

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=Manager,dc=example,dc=com

dn: olcDatabase={2}hdb,cn=config
changetype: modify
add: olcRootPW
olcRootPW: {SSHA}sWdvM8tQw3JomdNrpQSM3IEYUn6pDBis
</span></code></pre></div>
<h4>流し込む</h4>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> ldapmodify <span class="nt">-x</span> <span class="nt">-D</span> <span class="nv">cn</span><span class="o">=</span>config <span class="nt">-W</span> <span class="nt">-f</span> ~/ldap_work/change-domain.ldif
<span class="go">Enter LDAP Password:
modifying entry "olcDatabase={1}monitor,cn=config"

modifying entry "olcDatabase={2}hdb,cn=config"

modifying entry "olcDatabase={2}hdb,cn=config"

modifying entry "olcDatabase={2}hdb,cn=config"
</span></code></pre></div>
<h4>ベースエントリを登録する</h4>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> vi ~/ldap_work/base.ldif
<span class="go">dn: dc=example,dc=com
objectClass: dcObject
objectClass: organization
dc: example
o: Example Inc.

dn: ou=People,dc=example,dc=com
objectClass: organizationalUnit
ou: People

dn: ou=Group,dc=example,dc=com
objectClass: organizationalUnit
ou: Group
</span></code></pre></div>
<h4>流し込む</h4>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> ldapadd <span class="nt">-x</span> <span class="nt">-D</span> <span class="s2">"cn=Manager,dc=example,dc=com"</span> <span class="nt">-W</span> <span class="nt">-f</span> ~/ldap_work/base.ldif
<span class="go">Enter LDAP Password:
adding new entry "dc=example,dc=com"

adding new entry "ou=People,dc=example,dc=com"

adding new entry "ou=Group,dc=example,dc=com"
</span></code></pre></div>
<h3>グループエントリを登録する</h3>

<p>作業用フォルダを作成する</p>
<div class="highlight"><pre class="highlight plaintext"><code># mkdir ~/ldap_work/ldif
</code></pre></div>
<p>エントリ用ファイルを作成する</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> vi ~/ldap_work/ldif/group.ldif
<span class="go">dn: cn=system,ou=Group,dc=example,dc=com
objectClass: posixGroup
objectClass: top
cn: system
gidNumber: 1000
</span></code></pre></div>
<p>このまま登録しようとするとエラーがでる</p>
<div class="highlight"><pre class="highlight plaintext"><code>ldap_add: Invalid syntax (21)
    additional info: objectClass: value #0 invalid per syntax
</code></pre></div>
<p>原因は下記URLに書いてある<br/>
<a href="http://l-w-i.net/t/openldap/ldapadd_100.txt">http://l-w-i.net/t/openldap/ldapadd_100.txt</a></p>
<div class="highlight"><pre class="highlight plaintext"><code>LDIFファイル内のobjectClassで指定したクラス名が誤っている。
LDIFファイル内のobjectClassで指定したクラスが定義されているスキーマファイルをslapd.confでincludeしていない。
</code></pre></div>
<p>OLCになったことによりslapd.confにincludeする代わりにcn=configにschemaを追加する様になった<br/>
初期状態ではcoreのみがinclude入っている<br/>
UserとGroupに必要なのはposixGroup posixAccountなので<br/>
<code>/etc/openldap/schema/nis.ldif</code> を追加する必要があるが<br/>
<code>/etc/openldap/schema/nis.ldif</code>でmanegerがないと言われるので先に<code>/etc/openldap/schema/cosine.ldif</code>を入れてからnisを入れる</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> ldapadd <span class="nt">-x</span> <span class="nt">-W</span> <span class="nt">-D</span> <span class="nv">cn</span><span class="o">=</span>config <span class="nt">-f</span> /etc/openldap/schema/cosine.ldif
<span class="go">Enter LDAP Password:
adding new entry "cn=cosine,cn=schema,cn=config"
</span><span class="gp">#</span> ldapadd <span class="nt">-x</span> <span class="nt">-W</span> <span class="nt">-D</span> <span class="nv">cn</span><span class="o">=</span>config <span class="nt">-f</span> /etc/openldap/schema/nis.ldif
<span class="go">Enter LDAP Password:
adding new entry "cn=nis,cn=schema,cn=config"
</span></code></pre></div>
<p>問題なく登録されたらグループエントリを登録する</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> ldapadd <span class="nt">-x</span> <span class="nt">-D</span> <span class="s2">"cn=Manager,dc=example,dc=com"</span> <span class="nt">-W</span> <span class="nt">-f</span> ~/ldap_work/ldif/group.ldif
<span class="go">Enter LDAP Password:
adding new entry "cn=system,ou=Group,dc=example,dc=com"
</span></code></pre></div>
<h3>ユーザーエントリを登録する</h3>

<p>ユーザー用のパスワードを作成する</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> slappasswd
<span class="go">New password:
Re-enter new password:
{SSHA}MQKO56JaZKzcIPTLk305Nx/29YQcZgX6
</span></code></pre></div>
<p>hogeユーザー用エントリファイルを作成する</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> vi ~/ldap_work/ldif/user.ldif
<span class="go">dn: uid=hoge,ou=People,dc=example,dc=com
objectClass: shadowAccount
objectClass: posixAccount
objectClass: account
objectClass: top
cn: HogeHoge
uid: hoge
uidNumber: 1001
gidNumber: 1000
homeDirectory: /home/
loginShell: /bin/bash
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
shadowLastChange: 16175
userPassword: {SSHA}MQKO56JaZKzcIPTLk305Nx/29YQcZgX6
</span></code></pre></div>
<p>流し込む</p>
<div class="highlight"><pre class="highlight console"><code><span class="gp">#</span> ldapadd <span class="nt">-x</span> <span class="nt">-D</span> <span class="s2">"cn=Manager,dc=example,dc=com"</span> <span class="nt">-W</span> <span class="nt">-f</span> ~/ldap_work/ldif/user.ldif
<span class="go">Enter LDAP Password:
adding new entry "cn=system,ou=Group,dc=example,dc=com"
</span></code></pre></div>
        </div>
        <div class="col-lg-3 col-md-3">
          <div class="well">
            <h4>
              タグ
            </h4>
            <ul class="list-unstyled">
              <li>
                <a href="/tags/よちよちrb/">よちよちrb</a> (1)
              </li>
              <li>
                <a href="/tags/ubuntu/">ubuntu</a> (2)
              </li>
              <li>
                <a href="/tags/groonga/">groonga</a> (2)
              </li>
              <li>
                <a href="/tags/nginx/">nginx</a> (1)
              </li>
              <li>
                <a href="/tags/ossgate/">OSSGate</a> (1)
              </li>
              <li>
                <a href="/tags/ldap/">ldap</a> (1)
              </li>
              <li>
                <a href="/tags/centos/">centos</a> (1)
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              年
            </h4>
            <ul>
              <li>
                <a href="/2017/">2017</a> (1)
                <ul>
                  <li>
                    <a href="/2017/08/">8月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2016/">2016</a> (1)
                <ul>
                  <li>
                    <a href="/2016/09/">9月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2015/">2015</a> (5)
                <ul>
                  <li>
                    <a href="/2015/11/">11月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/10/">10月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/09/">9月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/07/">7月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/06/">6月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2014/">2014</a> (1)
                <ul>
                  <li>
                    <a href="/2014/12/">12月</a>(1)
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              最近の投稿
            </h4>
            <ul>
              <li>
                <a href="./">CentOS7でLDAP</a>
                <ul>
                  <li>
                    2017年08月01日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2016/09/26/ossgate/">OSSGateワークショップに参加した感想</a>
                <ul>
                  <li>
                    2016年09月26日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2015/11/12/nginx_maintenance/">Nginx　メンテナンス画面作成</a>
                <ul>
                  <li>
                    2015年11月12日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2015/10/02/groonga/">Groongaで学ぶ全文検索 2015-10-02に参加</a>
                <ul>
                  <li>
                    2015年10月02日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2015/09/18/groonga/">Groongaで学ぶ全文検索 2015-09-18に参加</a>
                <ul>
                  <li>
                    2015年09月18日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2015/07/29/ubuntu_bower/">ubuntuにBowerを入れるときハマった事</a>
                <ul>
                  <li>
                    2015年07月29日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2015/06/19/ricty_font/">Rictyフォントのインストール</a>
                <ul>
                  <li>
                    2015年06月19日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2014/12/15/blog/">はじめてのBlog</a>
                <ul>
                  <li>
                    2014年12月15日
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <hr />
      <p class="text-center">
        2016 <a href="/">GakuBlog</a>
      </p>
    </div>
    <script src="../../../../js/all.js" type="text/javascript"></script><script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(["_setAccount", "UA-57646652-2"]);
      _gaq.push(["_trackPageview"]);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>