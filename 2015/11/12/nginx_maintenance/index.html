<!doctype html> 
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="hPEM88DJIkoFEORP5k4twCs5-g0h9euejtqoCUBExXk" name="google-site-verification" />
    <title>GakuBlog | Nginx　メンテナンス画面作成</title>
    <meta content="Nginxを利用しているサービスをメンテナンスする際に、Nginxの設定を変更したり再起動せずにメンテナンス画面に切り替えるようにする
Nginxではif文を使うことができるので特定のファイルの..." name="description" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><!--[if lt IE 9]><script src="../../../../js/ie8.js" type="text/javascript"></script><![endif]--><link href="../../../../css/all.css" media="screen" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">GakuBlog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav"></ul>
          <ul class="list-unstyled list-inline nav navbar-nav navbar-right">
            <li>
              <a href="https://twitter.com/Gaku07jp"><i class="fa fa-twitter-square fa-lg fa-inverse"></i></a>
            </li>
            <li>
              <a href="/feed.xml"><i class="fa fa-rss-square fa-lg fa-inverse"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-9">
          <h1>
            Nginx　メンテナンス画面作成
          </h1>
          <small class="label label-default">nginx</small>
          <hr />
          <p>
            <span class="glyphicon glyphicon-time"></span> 投稿日 2015年11月12日
          </p>
          <hr /><p>Nginxを利用しているサービスをメンテナンスする際に、Nginxの設定を変更したり再起動せずにメンテナンス画面に切り替えるようにする<br/>
Nginxではif文を使うことができるので特定のファイルの有無を判定してメンテナンス中かどうかを判定する<br/>
メンテナンスモードの場合はHTTPステータスコードを503で返し、指定されたファイルを表示する<br/>
リダイレクトする形式と違い、そのままのURLで利用できる</p>

<h3>前提</h3>

<ul>
<li>メンテナンス用ファイルは /var/www/maintenance に置く<br/></li>
<li>特権権限で/var/tmp/do_maintenanceファイルを作成できる</li>
</ul>

<p>メンテナンス用フォルダ構成</p>
<div class="highlight"><pre class="highlight plaintext"><code>/var/www/maintenance/
|-- css
|   `-- style.css
|-- image
|   |-- footer_logo.png
|   `-- header_logo.png
`-- maintenance.html
</code></pre></div>
<p>nginxの設定ファイル</p>
<div class="highlight"><pre class="highlight nginx"><code><span class="c1"># メンテナンス判定用のフラグを定義
</span><span class="k">set</span> <span class="nv">$maintenance</span> <span class="s">false</span><span class="p">;</span>

<span class="c1">#/var/tmp/domaintenanceファイルの有無を確認し、フラグの判定
</span><span class="k">if</span> <span class="s">(-e</span> <span class="n">/var/tmp/do_maintenance</span> <span class="s">)</span> <span class="p">{</span>
  <span class="kn">set</span> <span class="nv">$maintenance</span> <span class="s">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#メンテナンス中でもサイトを確認するため
#特定IPからは通常どおり表示させる
</span><span class="k">if</span> <span class="s">(</span><span class="nv">$remote_addr</span> <span class="p">=</span> <span class="s">xxx.xxx.xxx.xxx)</span> <span class="p">{</span>
  <span class="kn">set</span> <span class="nv">$maintenance</span> <span class="s">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#すべてのリクエストを503で返すと画像とCSSも表示できなくなるため画像とCSSは503で返さないようにする
#http://~~~/maintenance/css/***.css
#http://~~~/maintenance/images/***.png
#http://~~~/maintenance/images/***.jpeg
#http://~~~/image/favicon.ico
#上記のファイルは503にせず通す
</span><span class="k">if</span> <span class="s">(</span><span class="nv">$request_uri</span> <span class="p">~</span> <span class="sr">^/(maintenance/css/.*\.css|maintenance/image/.*\.(png|jpg)|images/favicon.ico))</span> <span class="p">{</span>
  <span class="kn">set</span> <span class="nv">$maintenance</span> <span class="s">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#メンテナンス判定フラグがtrueの場合は503を返す
</span><span class="k">if</span> <span class="s">(</span><span class="nv">$maintenance</span> <span class="p">=</span> <span class="s">true)</span> <span class="p">{</span>
  <span class="kn">return</span> <span class="mi">503</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#画像とCSSのlocationを設定する
</span><span class="k">location</span>  <span class="p">~</span> <span class="sr">^/maintenance/css/</span> <span class="p">{</span>
  <span class="kn">root</span> <span class="n">/var/www/</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span>  <span class="p">~</span> <span class="sr">^/maintenance/image/</span> <span class="p">{</span>
  <span class="kn">root</span> <span class="n">/var/www/</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">#上で返した503のページを設定する
#設定されていない場合は404になる為注意
</span><span class="k">error_page</span> <span class="mi">503</span> <span class="s">@maintenance</span><span class="p">;</span>
<span class="k">location</span> <span class="s">@maintenance</span> <span class="p">{</span>
  <span class="kn">root</span> <span class="n">/var/www/maintenance</span><span class="p">;</span>
  <span class="kn">rewrite</span> <span class="s">^(.*)</span>$ <span class="n">/maintenance.html</span> <span class="s">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>設定が完了したらnginxを再起動</p>
<div class="highlight"><pre class="highlight plaintext"><code># service nginx restart
</code></pre></div>
<p>再起動後はメンテナンス実施時に下記コマンドを利用するだけでメンテナンスモードにできるようになる</p>

<h4>メンテナンスモード設定</h4>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo touch /var/tmp/do_maintenance
</code></pre></div>
<h4>メンテナンスモード解除</h4>
<div class="highlight"><pre class="highlight plaintext"><code>$ sudo rm /var/tmp/do_maintenance
</code></pre></div>
        </div>
        <div class="col-lg-3 col-md-3">
          <div class="well">
            <h4>
              タグ
            </h4>
            <ul class="list-unstyled">
              <li>
                <a href="/tags/よちよちrb/">よちよちrb</a> (1)
              </li>
              <li>
                <a href="/tags/ubuntu/">ubuntu</a> (2)
              </li>
              <li>
                <a href="/tags/groonga/">groonga</a> (2)
              </li>
              <li>
                <a href="/tags/nginx/">nginx</a> (1)
              </li>
              <li>
                <a href="/tags/ossgate/">OSSGate</a> (1)
              </li>
              <li>
                <a href="/tags/ldap/">ldap</a> (1)
              </li>
              <li>
                <a href="/tags/centos/">centos</a> (1)
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              年
            </h4>
            <ul>
              <li>
                <a href="/2017/">2017</a> (1)
                <ul>
                  <li>
                    <a href="/2017/08/">8月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2016/">2016</a> (1)
                <ul>
                  <li>
                    <a href="/2016/09/">9月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2015/">2015</a> (5)
                <ul>
                  <li>
                    <a href="/2015/11/">11月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/10/">10月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/09/">9月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/07/">7月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/06/">6月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2014/">2014</a> (1)
                <ul>
                  <li>
                    <a href="/2014/12/">12月</a>(1)
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              最近の投稿
            </h4>
            <ul>
              <li>
                <a href="../../../../2017/08/01/centos7_ldap/">CentOS7でLDAP</a>
                <ul>
                  <li>
                    2017年08月01日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2016/09/26/ossgate/">OSSGateワークショップに参加した感想</a>
                <ul>
                  <li>
                    2016年09月26日
                  </li>
                </ul>
              </li>
              <li>
                <a href="./">Nginx　メンテナンス画面作成</a>
                <ul>
                  <li>
                    2015年11月12日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../10/02/groonga/">Groongaで学ぶ全文検索 2015-10-02に参加</a>
                <ul>
                  <li>
                    2015年10月02日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../09/18/groonga/">Groongaで学ぶ全文検索 2015-09-18に参加</a>
                <ul>
                  <li>
                    2015年09月18日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../07/29/ubuntu_bower/">ubuntuにBowerを入れるときハマった事</a>
                <ul>
                  <li>
                    2015年07月29日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../06/19/ricty_font/">Rictyフォントのインストール</a>
                <ul>
                  <li>
                    2015年06月19日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2014/12/15/blog/">はじめてのBlog</a>
                <ul>
                  <li>
                    2014年12月15日
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <hr />
      <p class="text-center">
        2016 <a href="/">GakuBlog</a>
      </p>
    </div>
    <script src="../../../../js/all.js" type="text/javascript"></script><script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(["_setAccount", "UA-57646652-2"]);
      _gaq.push(["_trackPageview"]);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>