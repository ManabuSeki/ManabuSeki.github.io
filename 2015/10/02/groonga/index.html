<!doctype html> 
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="hPEM88DJIkoFEORP5k4twCs5-g0h9euejtqoCUBExXk" name="google-site-verification" />
    <title>GakuBlog | Groongaで学ぶ全文検索 2015-10-02に参加</title>
    <meta content="今回は実際に作って使ってみる Groongaという事でMroongaを使ったRailsi製アプリで実際に全文検索を使うアプリを作ってみました

※rails new の部分は省きます

Mroonga..." name="description" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><!--[if lt IE 9]><script src="../../../../js/ie8.js" type="text/javascript"></script><![endif]--><link href="../../../../css/all.css" media="screen" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">GakuBlog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav"></ul>
          <ul class="list-unstyled list-inline nav navbar-nav navbar-right">
            <li>
              <a href="https://twitter.com/Gaku07jp"><i class="fa fa-twitter-square fa-lg fa-inverse"></i></a>
            </li>
            <li>
              <a href="/feed.xml"><i class="fa fa-rss-square fa-lg fa-inverse"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-9">
          <h1>
            Groongaで学ぶ全文検索 2015-10-02に参加
          </h1>
          <small class="label label-default">groonga</small>
          <hr />
          <p>
            <span class="glyphicon glyphicon-time"></span> 投稿日 2015年10月02日
          </p>
          <hr /><p>今回は実際に作って使ってみる Groongaという事でMroongaを使ったRailsi製アプリで実際に全文検索を使うアプリを作ってみました</p>

<p>※rails new の部分は省きます</p>

<h3>Mroongaとは</h3>

<p>Mroongaは全文検索が得意なMySQLのステレージエンジン<br/>
Mroongaはトランザクションがない分検索が早い<br/>
今回はMroongaを利用するためにMySQLを利用し全文検索を行いました</p>

<h3>Railsアプリ作成</h3>

<p>今回は全文検索を行いやすくするためGroongaBlogというお題で作成を開始します</p>

<p>Gemfileにmysql2を追加します</p>

<p>Gemfile</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">gem</span> <span class="s1">'mysql2'</span><span class="p">,</span> <span class="s1">'~&gt; 0.3.20'</span>
</code></pre></div>
<p>mysql2を追加してbundle install</p>

<p>今回はBlogということでscaffoldでPost機能を作成します</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rails</span> <span class="n">g</span> <span class="no">Post</span> <span class="n">title</span> <span class="n">body</span><span class="ss">:text</span>

<span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span>
</code></pre></div>
<p>これでタイトルと本文があるブログ機能ができました</p>

<p>この状態で<br/>
まず全文検索を使ってみる</p>

<p>今回は簡易的にURLパラメータに<code>keyword</code>を追加し、そのkeywordを検索対象にする<br/>
　</p>

<p>posts_controller.rb</p>

<p>変更前</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">all</span>
<span class="k">end</span>
</code></pre></div>
<p>LIKE検索に変更する</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'body LIKE ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">]</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>これでkeywordで入ってきた単語を全文検索する事ができる</p>
<div class="highlight"><pre class="highlight plaintext"><code>http://localhost:3000/posts?keyword=hogehoge
</code></pre></div>
<p>LIKE検索の時MySQLは逐次検索を行うので文章の量が増加するに従って遅くなる<br/>
文章量が少ないサービスやシステムでは全文検索エンジンを使う必要がないが、<br/>
検索エンジンを使う一つの目安として検索に1秒以上かかる場合は検索エンジンを検討するといいと言っていました</p>

<p>今回はMroongaを利用するのでまずMroongaのインストールから行う</p>

<h3>Mroongaインストール</h3>

<p>インストール方法の詳細は<a href="http://mroonga.org/ja/docs/install.html">mroongaドキュメント</a>を参照</p>

<p>Macの場合</p>
<div class="highlight"><pre class="highlight plaintext"><code>brew install https://raw.github.com/mroonga/homebrew/master/mroonga.rb --use-homebrew-mysql
</code></pre></div>
<p>トークナイザーとして<a href="http://mecab.googlecode.com/svn/trunk/mecab/doc/index.html">MeCab</a>を利用する場合は<code>--with-mecab</code>オプション付きでインストールしてください。</p>

<p>MeCabサポート付きでインストール</p>
<div class="highlight"><pre class="highlight plaintext"><code>brew install https://raw.github.com/mroonga/homebrew/master/mroonga.rb --use-homebrew-mysql --with-mecab
</code></pre></div>
<p>今回は使ってみるというのが大事なのでトークナイザーは指定しませんでした</p>

<p>Mroongaのインストールが完了したら成功しているかmysqlにログインし、下記コマンドを実行して確認する</p>
<div class="highlight"><pre class="highlight plaintext"><code>mysql&gt; SHOW PLUGINS;

+-------------------+----------+--------------------+---------------+---------+
| Name              | Status   | Type               | Library       | License |
+-------------------+----------+--------------------+---------------+---------+
| Mroonga           | ACTIVE   | STORAGE ENGINE     | ha_mroonga.so | GPL     |
+-------------------+----------+--------------------+---------------+---------+
</code></pre></div>
<p>このように一番下に追加されていればインストール完了です</p>

<h3>ここからRailsでMroongaを利用する方法を実践して行きます</h3>

<p>まず、大きく分けてやる事は下記の3Step<br/>
Step 1. ストレージエンジンをInnoDBからMroongaに切り替える<br/>
Step 2. 検索したい対象のカラムに対してIndexを作成する<br/>
Step 3. LIKEでそのまま検索しても検索速度はかわらないので検索方法を修正する</p>

<p>の3ステップです</p>

<h3>Step 1</h3>

<p>ストレージエンジンをInnoDBからMroongaに切り替える</p>

<p>ストレージエンジンを切り替えるためにmigrationファイルを作成します</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">migration</span> <span class="no">ChangeEngineToMroonga</span>
</code></pre></div>
<p>作成したmigrationファイルを編集します</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ChangeEngineToMroonga</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span> 
    <span class="n">reversible</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
      <span class="n">dir</span><span class="p">.</span><span class="nf">up</span> <span class="k">do</span>
        <span class="n">execute</span> <span class="s1">'ALTER TABLE posts ENGINE=Mroonga;'</span>
      <span class="k">end</span>

      <span class="n">dir</span><span class="p">.</span><span class="nf">down</span> <span class="k">do</span>
        <span class="n">execute</span> <span class="s1">'ALTER TABLE posts ENGINE=InnoDB;'</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>作成したらmigrationを実行します</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span>
</code></pre></div>
<p>実際にMySQLにログインしてEngineがMroongaに変更されているか確認をします</p>
<div class="highlight"><pre class="highlight plaintext"><code>mysql&gt; show create table posts;
+-------+---------------------------------------------------------------------------------+
| Table | Create Table                                                                    |
+-------+---------------------------------------------------------------------------------+
| posts | CREATE TABLE `posts` (                                                          |
|       |   `id` int(11) NOT NULL AUTO_INCREMENT,                                         |
|       |   `title` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL,                    |
|       |   `body` text COLLATE utf8_unicode_ci,                                          |
|       |   `created_at` datetime NOT NULL,                                               |
|       |   `updated_at` datetime NOT NULL,                                               |
|       |   PRIMARY KEY (`id`)                                                            |
|       | ) ENGINE=Mroonga AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci  |
+-------+---------------------------------------------------------------------------------+
1 row in set (0.00 sec)
</code></pre></div>
<p>これでストレージエンジンをMroongaに変更できました</p>

<h3>Step 2</h3>

<p>検索したい対象のカラムに対してIndexを作成する</p>

<p>対象カラムに対してIndexを追加するためmigrationファイルを作成します</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">migration</span> <span class="no">AddFulltextIndexToBody</span>
</code></pre></div>
<p>作成したmigrationファイルを編集します</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">AddFulltextIndexToBody</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">change_table</span> <span class="ss">:posts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">type: :fulltext</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>ここでpostsテーブルのbodyに対して typeにfulltextを追加してIndexを追加します<br/>
作成したらmigrationを実行します</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span>
</code></pre></div>
<p>実際にMySQLにログインしてインデックスが追加されたか確認します</p>
<div class="highlight"><pre class="highlight plaintext"><code>mysql&gt; show create table posts;
+-------+---------------------------------------------------------------------------------+
| Table | Create Table                                                                    |
+-------+---------------------------------------------------------------------------------+
| posts | CREATE TABLE `posts` (                                                          |
|       |   `id` int(11) NOT NULL AUTO_INCREMENT,                                         |
|       |   `title` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL,                    |
|       |   `body` text COLLATE utf8_unicode_ci,                                          |
|       |   `created_at` datetime NOT NULL,                                               |
|       |   `updated_at` datetime NOT NULL,                                               |
|       |   PRIMARY KEY (`id`)                                                            |
|       |   FULLTEXT KEY `index_posts_on_body` (`body`)                                   |
|       | ) ENGINE=Mroonga AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci  |
+-------+---------------------------------------------------------------------------------+
1 row in set (0.00 sec)
</code></pre></div>
<p>インデックスが追加されました</p>

<h3>Step 3</h3>

<p>LIKEでそのまま検索しても検索速度はかわらないので検索方法を修正する</p>

<p>posts_controller.rb</p>
<div class="highlight"><pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'MATCH(body) AGAINST(? IN BOOLEAN MODE)'</span><span class="p">,</span> <span class="s2">"+</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div>
<h4>BOOLEAN MODEとは</h4>

<p>これら語句を必ず含むレコード」や、「この語句を含んで、この語句を含まないレコード」を検索できるモード<br/>
+でキーワードを含む<br/>
- でキーワードを含まない<br/>
検索を指定できる</p>

<p>繋げて書く事で AND検索にできる</p>

<h4>NATURAL LANGUAGE MODEとは</h4>

<p>デフォルトで設定されている修飾子<br/>
文章から検索結果を出す</p>

<p>これでMroongaを使った全文検索の完成です</p>

<p>思っていたよりずっと簡単に使う事ができました。</p>

<p>今日の内容は濃かった！！</p>

<p>次回、<a href="https://groonga.doorkeeper.jp/events/32517">Groongaで学ぶ全文検索 2015-10-16</a></p>

        </div>
        <div class="col-lg-3 col-md-3">
          <div class="well">
            <h4>
              タグ
            </h4>
            <ul class="list-unstyled">
              <li>
                <a href="/tags/よちよちrb/">よちよちrb</a> (1)
              </li>
              <li>
                <a href="/tags/ubuntu/">ubuntu</a> (2)
              </li>
              <li>
                <a href="/tags/groonga/">groonga</a> (2)
              </li>
              <li>
                <a href="/tags/nginx/">nginx</a> (1)
              </li>
              <li>
                <a href="/tags/ossgate/">OSSGate</a> (1)
              </li>
              <li>
                <a href="/tags/ldap/">ldap</a> (1)
              </li>
              <li>
                <a href="/tags/centos/">centos</a> (1)
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              年
            </h4>
            <ul>
              <li>
                <a href="/2017/">2017</a> (1)
                <ul>
                  <li>
                    <a href="/2017/08/">8月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2016/">2016</a> (1)
                <ul>
                  <li>
                    <a href="/2016/09/">9月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2015/">2015</a> (5)
                <ul>
                  <li>
                    <a href="/2015/11/">11月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/10/">10月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/09/">9月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/07/">7月</a>(1)
                  </li>
                  <li>
                    <a href="/2015/06/">6月</a>(1)
                  </li>
                </ul>
              </li>
              <li>
                <a href="/2014/">2014</a> (1)
                <ul>
                  <li>
                    <a href="/2014/12/">12月</a>(1)
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              最近の投稿
            </h4>
            <ul>
              <li>
                <a href="../../../../2017/08/01/centos7_ldap/">CentOS7でLDAP</a>
                <ul>
                  <li>
                    2017年08月01日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2016/09/26/ossgate/">OSSGateワークショップに参加した感想</a>
                <ul>
                  <li>
                    2016年09月26日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../11/12/nginx_maintenance/">Nginx　メンテナンス画面作成</a>
                <ul>
                  <li>
                    2015年11月12日
                  </li>
                </ul>
              </li>
              <li>
                <a href="./">Groongaで学ぶ全文検索 2015-10-02に参加</a>
                <ul>
                  <li>
                    2015年10月02日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../09/18/groonga/">Groongaで学ぶ全文検索 2015-09-18に参加</a>
                <ul>
                  <li>
                    2015年09月18日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../07/29/ubuntu_bower/">ubuntuにBowerを入れるときハマった事</a>
                <ul>
                  <li>
                    2015年07月29日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../06/19/ricty_font/">Rictyフォントのインストール</a>
                <ul>
                  <li>
                    2015年06月19日
                  </li>
                </ul>
              </li>
              <li>
                <a href="../../../../2014/12/15/blog/">はじめてのBlog</a>
                <ul>
                  <li>
                    2014年12月15日
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <hr />
      <p class="text-center">
        2016 <a href="/">GakuBlog</a>
      </p>
    </div>
    <script src="../../../../js/all.js" type="text/javascript"></script><script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(["_setAccount", "UA-57646652-2"]);
      _gaq.push(["_trackPageview"]);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>